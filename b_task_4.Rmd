---
title: ''
author: ''
knit: (function(inputFile, encoding) {
    rmarkdown::render(inputFile, encoding = encoding, output_dir = "out_knit")})
---

## Task on slide 343

With the function you defined in `func_drug_conc.R`, run the drug concentration
model with `r2` taking values uniformly between 1/8 and 1/10, and plot the results.

```{r fig1, message=FALSE, warning=FALSE, out.width="60%", fig.asp=1, fig.cap = "Drug concentration", fig.align = "center",  class.source = "fold-hide", echo = TRUE}
library("ggplot2")
library("deSolve")
library("tidyr")
library("dplyr")
rm(list = ls())
source(file.path("func", "func_drug_conc.R"))

init_state_dc <- c(x = 1, y = 0)
tps <- seq(0, 30, by = 0.01)

r2_values <- seq(1 / 10, 1 / 8, by = 0.005)

base_dc_out <- deSolve::ode(y = init_state_dc, times = tps, func = func_drug_conc, parms = c(r1 = 1 / 3, r2 = r2_values[1]))
output_dc_df <- as.data.frame(base_dc_out)

for (r2_value in r2_values[2: length(r2_values)]) {  # already have data for first r2 value so start from r2_values[2:]
  parameters_dc <- c(r1 = 1 / 3, r2 = r2_value)
  tmp_dc_out <- deSolve::ode(y = init_state_dc, times = tps, func = func_drug_conc, parms = parameters_dc, method = "euler")
  tmp_dc_df <- as.data.frame(tmp_dc_out)
  tmp_dc_df <- tmp_dc_df[, c("y"), drop = FALSE]
  colnames(tmp_dc_df) <- paste0(c("y_"), "r2_", r2_value)

  # Bind to the main data frame
  output_dc_df <- cbind(output_dc_df, tmp_dc_df)
}
output_dc_df <- output_dc_df %>%
  pivot_longer(
    cols = starts_with("y_"),
    names_to = "r2_value",
    values_to = "y_value"
  )

ggplot(output_dc_df) +
  geom_line(aes(x = time, y = x, color = "x")) +
  geom_line(aes(x = time, y = y_value, color = "y", group = r2_value)) +
  scale_color_manual(values = c("x" = "blue", "y" = "red")) +
  labs(color = NULL, y = "Concentration")
```
